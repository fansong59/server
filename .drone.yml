workspace:
  base: /drone
  path: src/github.com/owncloud-docker/server

branches:
  - master

clone:
  git:
    image: plugins/git:1
    pull: true

pipeline:
  tarball:
    image: plugins/download:latest
    pull: true
    secrets: [ download_username, download_password ]
    source: https://download.owncloud.org/community/owncloud-${CORE_VERSION}.tar.bz2
    sha256: ${CORE_CHECKSUM}

  ldap:
    image: plugins/download:latest
    pull: true
    source: https://github.com/owncloud/user_ldap/releases/download/${LDAP_VERSION}/user_ldap.tar.gz
    sha256: ${LDAP_CHECKSUM}

  wait:
    image: owncloud/ubuntu:latest
    pull: true
    commands:
      - wait-for-it -t 600 docker:2375

  build:
    image: toolhippie/docker:latest
    pull: true
    environment:
      - DOCKER_HOST=tcp://docker:2375
    commands:
      - docker build -t owncloud/server:latest .

  server:
    image: toolhippie/docker:latest
    pull: true
    detach: true
    environment:
      - DOCKER_HOST=tcp://docker:2375
    commands:
      - |
        docker run -p 8000:80 \
        -e DEBUG=true \
        -e OWNCLOUD_APPS_INSTALL=https://github.com/owncloud/testing/releases/download/latest/testing.tar.gz \
        -e OWNCLOUD_APPS_ENABLE=testing \
        owncloud/server:latest

  prepare-acceptance-tests:
    image: owncloudci/php
    pull: true
    commands:
      - mkdir -p /drone/owncloud-smoketest
      - wget -qO- "https://download.owncloud.org/community/owncloud-daily-stable10-qa.tar.bz2" | tar -xj -C /drone/owncloud-smoketest --strip 1

  wait-for-owncloud:
    image: owncloud/ubuntu:latest
    pull: true
    commands:
      - wait-for-it -t 600 docker:8000

  run-api-smoke-test:
     image: owncloudci/php
     pull: true
     environment:
      - TEST_SERVER_URL=http://docker:8000
      - SKELETON_DIR=/mnt/data/apps/testing/data/apiSkeleton
     commands:
      - cd ./owncloud-smoketest/tests/acceptance
      - bash run.sh --remote --tags @smokeTest

  run-ui-smoke-test:
    image: owncloudci/php
    pull: true
    environment:
     - BROWSER=chrome
     - SELENIUM_HOST=selenium
     - SELENIUM_PORT=4444
     - PLATFORM=Linux
     - MAILHOG_HOST=email
     - TEST_SERVER_URL=http://docker:8000
     - SKELETON_DIR=/mnt/data/apps/testing/data/webUISkeleton
    commands:
     - cd ./owncloud-smoketest/tests/acceptance
     - bash run.sh --remote --tags @smokeTest

  publish:
    image: toolhippie/docker:latest
    pull: true
    secrets: [ docker_username, docker_password ]
    environment:
      - DOCKER_HOST=tcp://docker:2375
    commands:
      - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
      - |
        for IMAGE in ${IMAGE_TAGS}; do
          docker tag owncloud/server:latest owncloud/server:$IMAGE
          docker push owncloud/server:$IMAGE
        done
    when:
      event: [ push ]

  microbadger:
    image: plugins/webhook:1
    pull: true
    secrets: [ webhook_urls ]
    when:
      local: false
      event: [ push ]

  slack:
    image: plugins/slack:1
    pull: true
    secrets: [ slack_webhook ]
    channel: docker
    template: >
      *{{build.status}}* <{{build.link}}|{{repo.owner}}/{{repo.name}}#{{truncate build.commit 8}}> @ ${CORE_VERSION}
    when:
      local: false
      event: [ push ]
      status: [ changed, failure ]

services:
  docker:
    image: docker:18.04-dind
    pull: true

  selenium:
    image: selenium/standalone-chrome-debug:latest
    pull: true

matrix:
  include:
    - CORE_VERSION: 10.0.10
      CORE_CHECKSUM: a2efe484678c1659b9640ea247746a2174d77870d29c7d60abd565c20eb5aa84
      LDAP_VERSION: v0.11.0
      LDAP_CHECKSUM: e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
      IMAGE_TAGS: 10.0.9 10.0 latest
